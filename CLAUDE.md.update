# Claude Code 执行协议：全感知任务管理模式

> [!IMPORTANT]
> 你必须在所有交互中严格遵守此协议。这是你的核心操作逻辑，旨在通过“物理文件记录”和“末尾重述机制”对抗长上下文带来的注意力衰减。

## 核心行为准则
1. **先读取再行动**：启动会话或开始新任务前，必须先同步 `production.md` 和 `schema/` 目录下的状态。
2. **强制刷新**：每一次回复的末尾必须包含【当前快照】。
3. **文件驱动**：所有进度必须落实到 `schema/task_*.md`。

---

## 协议详细定义

### 0. 全局认知 (Global Awareness)
- **初始检查**：启动时检查根目录是否存在 `production.md`。若无，必须执行 `ls -R` 并读取核心文件创建它。
- **内容要求**：[项目定位]、[核心架构]、[技术栈]、[目录结构说明]、[部署流程]。
- **动态维护**：架构变更或模块新增时，同步更新此文件。

### 1. 任务启动 (Initialization)
- **触发条件**：收到以 `START: [任务描述]` 开头的指令。
- **存储路径**：`schema/` 目录下。
- **命名规范**：执行 `date` 获取日期，格式为 `schema/task_[简码]_[YYMMDD].md`。
- **动作**：创建文件并列出最终目标、拆解步骤，然后再开始执行。

### 2. 动态上下文刷新 (Dynamic Refreshing)
- **执行规则**：任务期间的**每一次回复**，必须执行：
  1. 完成实际的代码/命令。
  2. 更新 `schema/` 下的任务文档进度。
  3. **末尾重述（Recency Bias 抗性）**：在回复末尾必须包裹以下代码块：
     ```text
     [项目全局状态]: 已同步至 production.md
     [当前任务文件]: <schema/文件名>
     [当前目标]: <一句话目标>
     [已完成]: <最近一步操作>
     [下一步]: <紧接着要执行的原子动作>
     ```

### 3. 任务结项 (Termination)
- **触发条件**：收到 `task done 文件名`。
- **动作**：
  1. 代码一致性检查。
  2. 更新 `production.md` 反映新状态。
  3. 归档：将任务文件移至 `schema/archive/`。
  4. 确认关闭并停止回复末尾的重述。

### 4. 记忆对齐 (Context Re-sync)
- 会话重启后，依次 `cat production.md` 和最新的 `schema/task_*.md`，对齐认知后再回复。
