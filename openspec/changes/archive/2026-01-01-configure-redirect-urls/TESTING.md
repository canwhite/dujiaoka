# 手动测试指南 - configure-redirect-urls

## 测试前准备

### 环境检查
- [ ] 确认 `.env` 文件中已配置 `NOVEL_REDIRECT_URL`
- [ ] 确认 Laravel 配置缓存已清除：`php artisan config:clear`
- [ ] 确认队列进程正在运行：`php artisan queue:work`
- [ ] 确认可以访问支付页面

### 测试数据准备
创建测试订单时，需要在 `info` 字段中包含来源信息：
```
充值账号: test@example.com
来源: novel
```

---

## 测试场景

### 场景 1：环境变量已配置 + 有 from 参数

**目标**：验证自动跳转和手动返回都使用配置的 URL

**步骤**：
1. 确认 `.env` 中有 `NOVEL_REDIRECT_URL=http://127.0.0.1:3000`
2. 创建一个订单，info 字段包含"来源: novel"
3. 完成支付（或手动将订单状态改为已支付）
4. 访问支付成功页面（qrpay 页面）

**预期结果 - Unicorn 主题**：
- [ ] 显示确认对话框："支付成功！点击确定立即返回商户平台，或等待3秒自动跳转"
- [ ] 点击"确定"按钮 → 立即跳转到 `http://127.0.0.1:3000`
- [ ] 点击"取消"或等待 → 3秒后自动跳转到 `http://127.0.0.1:3000`

**预期结果 - Luna 主题**：
- [ ] 显示 Layer 弹窗："支付成功！点击确定立即返回商户平台"
- [ ] 点击"确定"按钮 → 立即跳转到 `http://127.0.0.1:3000`

**实际结果**：
```
记录你的测试结果...
```

---

### 场景 2：环境变量未配置 + 有 from 参数

**目标**：验证使用默认 URL

**步骤**：
1. 临时注释或删除 `.env` 中的 `NOVEL_REDIRECT_URL`
2. 运行 `php artisan config:clear`
3. 重复场景 1 的步骤

**预期结果**：
- [ ] 使用默认 URL `http://127.0.0.1:3000` 进行跳转
- [ ] 不报错，功能正常

**实际结果**：
```
记录你的测试结果...
```

---

### 场景 3：有 from 参数但来源不匹配

**目标**：验证回退到默认订单详情页

**步骤**：
1. 创建订单，info 字段包含"来源: unknown"（不存在的来源）
2. 完成支付
3. 访问支付成功页面

**预期结果**：
- [ ] 跳转到默认的订单详情页
- [ ] URL 格式：`/detail-order-sn/{订单号}`

**实际结果**：
```
记录你的测试结果...
```

---

### 场景 4：没有 from 参数

**目标**：验证回退到默认订单详情页

**步骤**：
1. 创建订单，info 字段**不包含**来源信息
2. 完成支付
3. 访问支付成功页面

**预期结果 - Unicorn 主题**：
- [ ] 显示："支付成功！点击确定查看订单详情，或等待3秒自动跳转"
- [ ] 跳转到订单详情页

**预期结果 - Luna 主题**：
- [ ] 显示："支付成功！点击确定查看订单详情"
- [ ] 跳转到订单详情页

**实际结果**：
```
记录你的测试结果...
```

---

### 场景 5：URL 协议一致性

**目标**：验证 HTTP/HTTPS 混用情况

**步骤**：
1. 测试配置 `NOVEL_REDIRECT_URL=http://127.0.0.1:3000`（HTTP）
2. 测试配置 `NOVEL_REDIRECT_URL=https://example.com`（HTTPS）
3. 观察浏览器行为

**预期结果**：
- [ ] 如果协议不一致，浏览器可能有混合内容警告
- [ ] 跳转仍然成功

**实际结果**：
```
记录你的测试结果...
```

---

### 场景 6：两个主题的一致性

**目标**：验证 Unicorn 和 Luna 主题行为一致

**对比测试**：
- [ ] Unicorn 主题的所有场景都通过
- [ ] Luna 主题的所有场景都通过
- [ ] 两个主题的跳转目标一致

---

## 测试检查清单

### 功能测试
- [ ] 自动跳转（3秒后）正常工作
- [ ] 手动返回按钮（确认对话框）正常工作
- [ ] from 参数正确提取
- [ ] redirect_urls 配置正确读取
- [ ] 默认值回退机制正常

### 用户体验测试
- [ ] 提示信息清晰易懂
- [ ] 跳转时机合适（3秒）
- [ ] 按钮响应及时
- [ ] 两个主题体验一致

### 兼容性测试
- [ ] 不同浏览器（Chrome、Firefox、Safari）
- [ ] 移动端浏览器
- [ ] 桌面端浏览器

### 边界条件测试
- [ ] 空的 from 参数
- [ ] 不存在的来源
- [ ] 无效的重定向 URL
- [ ] 网络延迟情况

---

## 测试结果汇总

### 通过的场景
- [ ] 场景 1：环境变量已配置 + 有 from 参数
- [ ] 场景 2：环境变量未配置 + 有 from 参数
- [ ] 场景 3：来源不匹配
- [ ] 场景 4：没有 from 参数
- [ ] 场景 5：URL 协议一致性
- [ ] 场景 6：主题一致性

### 发现的问题
```
记录测试中发现的问题：
1.
2.
3.
```

### 测试结论
```
总体评价：
- 功能完整性：
- 用户体验：
- 稳定性：
- 建议改进：
```

---

## 快速测试命令

```bash
# 1. 清除配置缓存
php artisan config:clear

# 2. 查看当前配置
cat .env | grep NOVEL_REDIRECT_URL

# 3. 检查 PayController 代码
cat app/Http/Controllers/PayController.php | grep -A 5 "redirect_urls"

# 4. 查看订单信息（根据实际订单号）
mysql -u root -p -e "SELECT order_sn, info, status FROM orders WHERE order_sn = 'YOUR_ORDER_SN'"

# 5. 监控日志
tail -f storage/logs/laravel.log
```

---

## 回归测试检查

修改后需要确认以下功能未受影响：

- [ ] 正常支付流程（无 from 参数）
- [ ] 订单详情页正常显示
- [ ] 其他支付方式正常工作
- [ ] API 回调正常触发
- [ ] 队列任务正常执行

---

## 测试完成确认

- [ ] 所有测试场景已执行
- [ ] 测试结果已记录
- [ ] 发现的问题已修复
- [ ] 代码已提交
- [ ] 文档已更新
