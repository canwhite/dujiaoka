server {
    # ==================== 基础配置 ====================
    listen 80;                  # 监听80端口（HTTP标准端口）
    server_name _;              # 匹配所有域名（_为通配符），适合Docker容器环境
    root /var/www/html/public;  # Laravel应用的public目录为网站根目录，public目录是Laravel唯一对外可访问的目录
    index index.php index.html index.htm;  #当用户访问网址时，会按照这个顺序访问文件

    # ==================== 安全头设置 ====================
    # 进允许同源页面嵌入此页面
    add_header X-Frame-Options "SAMEORIGIN" always;
    # 防止xss攻击吗，检测到xss的时候阻断渲染
    add_header X-XSS-Protection "1; mode=block" always;
    # 防止mime类型嗅探
    add_header X-Content-Type-Options "nosniff" always;
    # HTTPS→HTTP不发送Referer，其他情况发送，referer可以理解为源头网站
    add_header Referrer-Policy "no-referrer-when-downgrade" always;


    # ==================== 静态资源缓存配置 ====================
    # 对图片、字体、样式、脚本等静态资源进行长期缓存，减少贷款消耗，提升页面加载速度
    # location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|svg)$
    # | 符号  | 含义          | 示例                                 |
    # |-----|-------------|------------------------------------|
    # | 无符号 | 前缀匹配        | location /admin/ 匹配以 /admin/ 开头的路径 |
    # | =   | 精确匹配        | location = / 只匹配根路径                |
    # | ~   | 区分大小写的正则匹配  | ~ \.jpg$ 只匹配 .jpg，不匹配 .JPG         |
    # | ~*  | 不区分大小写的正则匹配 | ~* \.jpg$ 匹配 .jpg 和 .JPG     
    # 其他符号：
    # \. 转义的点号（匹配字面上的 . 字符）
    # $ 表示字符串结束
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|svg)$ {
        expires 1y;                         # 设置缓存过期时间为1年
        add_header Cache-Control "public, immutable";# public: 可被CDN和浏览器缓存 ，immutable: 资源永不改变，浏览器无需验证
        add_header X-Content-Type-Options nosniff;  # 防止MIME嗅探
        try_files $uri $uri/ =404;          # 尝试直接返回文件，不存在则返回404
    }

    # ==================== 上传文件目录配置 ====================
    # 用户上传的文件（如商品图片、订单附件等）存放位置
    location /uploads/ {
        alias /var/www/html/public/uploads/;   # 映射到实际的上传目录
        try_files $uri $uri/ =404;             # 文件不存在返回404
    }

    # ==================== Laravel路由重写规则 ====================
    # Laravel使用单一入口点（index.php）处理所有请求
    # 此配置实现前端控制器模式（Front Controller Pattern）
    location / {
        # $uri: 尝试直接访问文件（如静态资源）
        # $uri/: 尝试访问目录（如/abc/）
        # /index.php?$query_string: 文件不存在时，转发到index.php处理
        # $query_string: 保留原始查询参数（如?id=123）
        try_files $uri $uri/ /index.php?$query_string;
    }

    # ==================== PHP-FPM处理配置 ====================
    # 将.php文件请求转发给PHP-FPM进程处理
    # 容器内使用127.0.0.1:9000（本地端口）连接PHP-FPM
    location ~ \.php$ {
        fastcgi_pass 127.0.0.1:9000;        # PHP-FPM监听地址和端口 , Supervisor在同一容器内管理PHP-FPM进程
        fastcgi_index index.php;            # PHP脚本的默认索引文件
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;# PHP脚本的完整路径，$document_root就是root，
        #$fastcgi_script_name就是请求的脚本路径，https://example.com/index.php → $fastcgi_script_name = /index.php
        include fastcgi_params;              # 加载Nginx默认FastCGI参数配置

        # ---------------- PHP性能优化参数 ----------------
        fastcgi_buffers 16 16k;              # 分配16个16KB的缓冲区用于读取PHP响应，总计256KB，防止大响应被写入磁盘
        fastcgi_buffer_size 32k;             # 响应头缓冲区大小（32KB）
        client_max_body_size 100M;           # 允许上传的最大文件大小（100MB）适用于商品图片、订单附件等大文件上传
        fastcgi_read_timeout 300;            # 读取PHP响应的超时时间（300秒=5分钟）防止长时间运行的脚本被中断（如批量导入）
        fastcgi_send_timeout 300;            # 向PHP-FPM发送请求的超时时间（300秒）
    }

    # ==================== 安全访问控制 ====================
    # 禁止访问隐藏文件和敏感配置文件
    # location ~ /\.(?!well-known).*
    # 逐字符解析
    # | 符号             | 含义           | 说明                |
    # |----------------|--------------|-------------------|
    # | ~              | 区分大小写的正则匹配   | Nginx 会按正则表达式处理   |
    # | \.             | 转义的点号        | 匹配字面上的 . 字符       |
    # | (?!well-known) | 否定前瞻         | 断言后面不是 well-known |
    # | .*             | 匹配任意字符（除换行外） | 零次或多次             |
    # ---
    # 否定前瞻 (?!...) 详解
    # 什么是"前瞻"？
    # 前瞻（Lookahead）是一种正则表达式断言，用于匹配某个模式前面或后面的内容。
    # | 语法          | 名称   | 含义           |
    # |-------------|------|--------------|
    # | (?=pattern) | 肯定前瞻 | 后面是 pattern  |
    # | (?!pattern) | 否定前瞻 | 后面不是 pattern |

    #  对比
    # | 术语  | 英文         | 符号                  | 方向      |
    # |-----|------------|---------------------|---------|
    # | 前瞻  | Lookahead  | (?=...) 和 (?!...)   | 向前看（右边） |
    # | 后顾  | Lookbehind | (?<=...) 和 (?<!...) | 向后看（左边） |

    # 直观理解
    # /\.(?!well-known).* 
    # 翻译成人类语言：
    # 匹配以点号 . 开头，但后面紧跟着的字符串不是 well-known 的所有路径

    location ~ /\.(?!well-known).* {
        deny all;  # 拒绝所有以.开头的文件（.env、.git等）well-known目录除外（用于HTTPS证书验证等）
    }

    location ~ /\.ht {
        deny all;     # 禁止访问.htaccess文件（Apache配置文件）虽然Nginx不使用.htaccess，但防止泄露
    }

    # ==================== 错误页面配置 ====================
    error_page 404 /index.php;
        # 404错误交给Laravel处理，返回自定义404页面

    error_page 500 502 503 504 /50x.html;
        # 服务器错误（500、502、503、504）返回静态错误页
    location = /50x.html {
        root /usr/share/nginx/html;  # 使用Nginx默认错误页面
    }
}