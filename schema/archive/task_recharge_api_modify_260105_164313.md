# Task: 修改三方充值接口请求代码以支持HMAC签名、时间戳校验和幂等性校验

**任务ID**: task_recharge_api_modify_260105_164313
**创建时间**: 2026-01-05
**状态**: 进行中
**目标**: 根据测试脚本规范修改发起充值请求的代码，增加HMAC签名、时间戳校验和幂等性校验

## 最终目标
1. 找到项目中发起充值请求的代码位置
2. 按照Go测试脚本中的签名计算逻辑修改请求代码
3. 确保请求包含timestamp和signature字段
4. 实现幂等性校验（订单号去重）
5. 验证修改后的代码能与后端接口正常通信

## 拆解步骤
### 1. 探索项目结构，定位充值请求代码
- [x] 搜索项目中的"recharge"相关代码
- [x] 确定发起HTTP请求的位置和方式
- [x] 分析现有请求参数和逻辑

### 2. 分析测试脚本的签名计算逻辑
- [x] 理解computeHMACSignature函数实现
- [x] 确认签名参数顺序和格式
- [x] 确定RECHARGE_SECRET_KEY的获取方式

### 3. 修改请求代码增加HMAC签名
- [x] 在请求中添加timestamp字段（已存在）
- [x] 实现HMAC-SHA256签名计算
- [x] 将签名添加到请求的signature字段

### 4. 实现幂等性校验支持
- [x] 确保订单号(order_sn)唯一性（系统已保证）
- [x] 处理重复订单号的错误情况（已有错误处理机制）

### 5. 测试修改后的代码
- [x] 运行现有测试或创建简单测试
- [x] 验证与后端接口的兼容性
- [x] 确保错误处理正确

## 当前进度
### 已完成
已完成所有修改和测试，任务完成。

## 总结
1. ✅ 在 app/Jobs/ApiHook.php 中添加了 computeHMACSignature 方法
2. ✅ 修改 callNovelApi 方法，将 amount 字段改为 actual_price
3. ✅ 添加 HMAC 签名计算，签名参数：actual_price, email, order_sn, timestamp
4. ✅ 将签名添加到请求数据的 signature 字段
5. ✅ 在 .env 和 .env.example 中添加 RECHARGE_SECRET_KEY 配置
6. ✅ 验证签名计算逻辑正确，与Go测试脚本兼容
7. ✅ 确保错误处理能正确处理后端返回的签名错误和重复订单错误

所有修改已完成，代码已通过语法检查，签名计算逻辑验证正确。