# Task: 分析充值失败问题，查看日志并诊断原因

**任务ID**: task_recharge_failure_analysis_260105_173237
**创建时间**: 2026-01-05
**状态**: 进行中
**目标**: 分析充值失败问题，查看相关日志，找出充值未成功的原因

## 最终目标
1. 检查充值相关容器运行状态
2. 查看dujiaoka应用日志和novel-api日志
3. 分析充值过程中的错误信息
4. 确定充值失败的具体原因并提供解决方案

## 拆解步骤
### 1. 检查容器状态和基础服务
- [ ] 检查dujiaoka_app容器状态和日志
- [ ] 检查novel-api容器状态和日志
- [ ] 验证数据库和Redis连接状态
- [ ] 确认网络连接正常

### 2. 查看充值相关日志
- [ ] 查看dujiaoka应用日志中关于充值API调用的记录
- [ ] 查看novel-api接收到的充值请求和响应
- [ ] 分析HMAC签名验证相关的日志
- [ ] 检查订单处理和服务队列状态

### 3. 分析具体错误信息
- [ ] 识别错误类型（签名错误、网络错误、业务错误等）
- [ ] 检查请求参数是否正确（特别是新增的HMAC签名）
- [ ] 确认时间戳和签名计算是否正确
- [ ] 分析错误堆栈信息

### 4. 提出解决方案
- [ ] 根据错误类型提供修复建议
- [ ] 如果需要，调整签名计算或参数格式
- [ ] 验证修复方案

## 当前进度
### 正在进行: 提出解决方案
已完成novel-api充值接口代码分析，发现多个请求参数不匹配问题。

## 问题分析结果
根据对novel-api充值接口代码的详细分析，发现dujiaoka请求存在以下问题：

### 1. 字段名不匹配
- dujiaoka发送: `good_name`
- novel-api期望: `gd_name`

### 2. 数据类型错误
- dujiaoka发送: `actual_price` = "0.50" (字符串)
- novel-api期望: `actual_price` = 0.50 (整数或数字类型)

### 3. 缺少必需字段
- 缺少 `title` 字段
- 缺少 `order_info` 字段
- 缺少 `good_id` 字段

### 4. 时间戳问题
- 时间戳类型应为字符串，但dujiaoka发送数字
- 时间戳过期：请求时间戳1767605482(09:31:22)，当前时间1767605996(09:39:56)，相差514秒(8.57分钟)，超过5分钟限制

### 5. 签名参数值类型
- 签名计算需要所有参数值为字符串类型
- `actual_price`在签名中应为字符串"0.50"

## 下一步行动
1. 修改 app/Jobs/ApiHook.php 中的 callNovelApi 方法
2. 修正字段名映射：`good_name` → `gd_name`
3. 添加缺失字段：`title`、`order_info`、`good_id`
4. 确保数据类型正确：`actual_price` 应为数字类型
5. 解决时间戳过期问题：确保时间戳在5分钟内

## 已完成的修改
根据novel-api接口要求，已完成以下修改：

### 1. 字段名修正
- `good_name` → `gd_name` (第248行)

### 2. 添加缺失字段
- `title`: 使用订单标题 `$this->order->title`
- `order_info`: 使用订单信息 `$this->order->info`
- `good_id`: 使用商品ID `$goodInfo->id`

### 3. 数据类型修正
- `actual_price`: 转换为整数 `(int)($this->order->actual_price * 100)` (假设单位为分)
- `timestamp`: 确保为字符串类型 `(string)time()`

### 4. 签名参数修正
- 签名计算使用整数形式的 `actual_price` 字符串
- 时间戳使用字符串类型
- 参数顺序：`actual_price`, `email`, `order_sn`, `timestamp`

### 5. 时间戳处理
- 使用当前时间戳，确保在5分钟有效期内
- 时间戳转换为字符串类型以匹配接口要求

## 验证建议
1. 重新发起一笔充值订单进行测试
2. 查看dujiaoka应用日志和novel-api日志
3. 验证签名计算是否正确（可通过测试脚本验证）
4. 确认novel-api返回的状态码（应为200而非400）