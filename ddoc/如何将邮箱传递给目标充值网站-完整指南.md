# 如何将邮箱传递给目标充值网站 - 完整指南

## 一、核心问题

**Q: 充值账号应该是邮箱，如何将用户的邮箱信息传递给目标充值网站？**

**A: 有3种主要方式，根据你的业务场景选择**

---

## 二、三种传递方式对比

### 方式对比表

| 方案 | 适用场景 | 优点 | 缺点 | 配置难度 |
|------|---------|------|------|---------|
| **方案1: 邮箱即充值账号** | 平台用邮箱作为用户标识 | 简单直接，用户无需额外填写 | 依赖邮箱准确性 | ⭐ 简单 |
| **方案2: 自定义输入框** | 平台有专门的账号系统 | 灵活，支持多种账号格式 | 需要用户填写 | ⭐⭐ 中等 |
| **方案3: 邮箱+账号组合** | 需要同时传递邮箱和账号 | 信息完整，便于追踪 | 逻辑复杂 | ⭐⭐⭐ 复杂 |

---

## 三、方案1: 邮箱即充值账号 ⭐ 推荐

### 3.1 适用场景

- 目标充值平台使用邮箱作为用户标识
- 例如: ChatGPT Plus、Midjourney、各种SaaS服务
- 用户在目标平台注册的邮箱 = 充值账号

### 3.2 实现方式

#### 步骤1: 配置商品（无需自定义输入框）

**后台管理**:
```
商品管理 → 编辑商品 → 其他输入框配置
留空或不填写任何内容
```

**原因**: 用户已经在购买时填写了邮箱，直接使用即可

#### 步骤2: 修改API逻辑（直接使用email）

**文件**: `/var/www/recharge-api/public/index.php`

```php
<?php
/**
 * 充值API - 使用邮箱作为充值账号
 */
header('Content-Type: application/json');

// 接收回调数据
$input = file_get_contents('php://input');
$data = json_decode($input, true);

// 验证数据
if (!$data || !isset($data['order_sn'])) {
    http_response_code(400);
    echo json_encode(['error' => 'Invalid request']);
    exit;
}

// ⭐⭐⭐ 关键: 直接使用email作为充值账号
$rechargeAccount = $data['email'];  // 例如: user@example.com

// 记录日志
file_put_contents(
    '/var/www/recharge-api/logs/hook_' . date('Y-m-d') . '.log',
    date('Y-m-d H:i:s') . " - Order: {$data['order_sn']}, Email: {$rechargeAccount}\n",
    FILE_APPEND
);

try {
    // ⭐⭐⭐ 调用第三方充值API，传入邮箱
    $result = rechargeToPlatform($rechargeAccount, $data['actual_price'], $data);

    if ($result['success']) {
        // 充值成功
        sendNotificationEmail($rechargeAccount, $result);

        echo json_encode([
            'status' => 'success',
            'account' => $rechargeAccount,  // 返回邮箱
            'new_balance' => $result['balance'],
            'transaction_id' => $result['transaction_id']
        ]);
    } else {
        // 充值失败
        echo json_encode([
            'status' => 'failed',
            'error' => $result['error']
        ]);
    }

} catch (Exception $e) {
    http_response_code(500);
    echo json_encode(['error' => $e->getMessage()]);
}

/**
 * ⭐⭐⭐ 充值到第三方平台
 */
function rechargeToPlatform($email, $amount, $orderData) {
    // 第三方平台API配置
    $apiUrl = 'https://target-platform.com/api/recharge';
    $apiKey = 'your_api_key';
    $apiSecret = 'your_api_secret';

    // ⭐ 构建请求参数（使用email作为账号）
    $params = [
        'email' => $email,              // ← 邮箱作为充值账号
        'amount' => $amount,
        'currency' => 'USD',
        'timestamp' => time(),
        'order_id' => $orderData['order_sn'],
        'product_name' => $orderData['gd_name']
    ];

    // 生成签名
    $params['signature'] = generateSignature($params, $apiSecret);

    // 发送HTTP请求
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $apiUrl);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($params));
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_HTTPHEADER, [
        'Content-Type: application/json',
        'Authorization: Bearer ' . $apiKey
    ]);

    $response = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);

    // 解析响应
    $result = json_decode($response, true);

    if ($httpCode == 200 && isset($result['success']) && $result['success']) {
        return [
            'success' => true,
            'balance' => $result['new_balance'],
            'transaction_id' => $result['transaction_id']
        ];
    } else {
        return [
            'success' => false,
            'error' => $result['message'] ?? '充值失败'
        ];
    }
}

/**
 * 发送通知邮件
 */
function sendNotificationEmail($email, $result) {
    $to = $email;  // ← 充值的邮箱
    $subject = '充值成功通知';
    $message = "您的充值已成功!\n\n";
    $message .= "充值账号: " . $email . "\n";
    $message .= "充值后余额: " . $result['balance'] . "\n";
    $message .= "交易号: " . $result['transaction_id'] . "\n";

    // 发送邮件
    mail($to, $subject, $message);
}
```

### 3.3 完整数据流

```
用户购买流程:
1. 访问 /buy/1
2. 填写邮箱: user@example.com  ← 唯一需要填写的
3. 支付成功

API回调数据:
{
    "order_sn": "ABC123",
    "email": "user@example.com",  ← ⭐ 直接使用这个
    "actual_price": 100.00,
    ...
}

你的API处理:
$rechargeAccount = $data['email'];  // user@example.com

发送给目标平台:
{
    "email": "user@example.com",  // ← 邮箱作为账号
    "amount": 100.00,
    ...
}
```

### 3.4 优缺点分析

**优点**:
- ✅ 用户只需填写邮箱，体验简单
- ✅ 不需要额外配置输入框
- ✅ 代码逻辑简单

**缺点**:
- ⚠️ 依赖用户邮箱的准确性
- ⚠️ 如果目标平台不使用邮箱作为账号，则不适用

---

## 四、方案2: 自定义输入框 - 邮箱字段

### 4.1 适用场景

- 目标平台需要邮箱，但你希望用户明确确认
- 或者需要用户提供其他邮箱（非购买邮箱）

### 4.2 实现方式

#### 步骤1: 配置商品

**后台管理**:
```
商品管理 → 编辑商品 → 其他输入框配置
填写: recharge_email=充值邮箱=true
```

**字段说明**:
- `recharge_email` - 字段标识
- `充值邮箱` - 显示名称
- `true` - 必填

#### 步骤2: 用户购买时填写

**购买页面会显示**:
```
┌─────────────────────────────────────┐
│ Token充值                           │
│                                     │
│ 购买邮箱: [_______________]         │ ← 购买时的联系邮箱
│                                     │
│ ⚠️ 充值邮箱: [_______________]      │ ← 用户填写的充值邮箱
│                                     │
│ 价格: ¥100                          │
│ [购买]                              │
└─────────────────────────────────────┘
```

用户填写:
- 购买邮箱: `buyer@example.com` (用于接收订单通知)
- 充值邮箱: `user@example.com` (用于充值的目标账号)

#### 步骤3: API提取充值邮箱

**文件**: `/var/www/recharge-api/public/index.php`

```php
<?php
/**
 * 充值API - 从自定义输入框提取充值邮箱
 */
header('Content-Type: application/json');

// 接收回调数据
$input = file_get_contents('php://input');
$data = json_decode($input, true);

// ⭐⭐⭐ 提取充值邮箱
$rechargeEmail = extractRechargeEmail($data);

// 验证邮箱格式
if (!filter_var($rechargeEmail, FILTER_VALIDATE_EMAIL)) {
    http_response_code(400);
    echo json_encode(['error' => 'Invalid email format']);
    exit;
}

// 记录日志
file_put_contents(
    '/var/www/recharge-api/logs/hook_' . date('Y-m-d') . '.log',
    date('Y-m-d H:i:s') . " - Order: {$data['order_sn']}, RechargeEmail: {$rechargeEmail}\n",
    FILE_APPEND
);

try {
    // 调用充值API
    $result = rechargeToPlatform($rechargeEmail, $data['actual_price']);

    if ($result['success']) {
        // 充值成功，通知购买邮箱
        sendNotificationEmail($data['email'], $result);

        echo json_encode([
            'status' => 'success',
            'recharge_email' => $rechargeEmail,
            'new_balance' => $result['balance']
        ]);
    } else {
        echo json_encode(['status' => 'failed', 'error' => $result['error']]);
    }

} catch (Exception $e) {
    http_response_code(500);
    echo json_encode(['error' => $e->getMessage()]);
}

/**
 * ⭐⭐⭐ 提取充值邮箱（从order_info）
 */
function extractRechargeEmail($orderData) {
    $orderInfo = $orderData['order_info'] ?? '';

    // 格式1: "充值邮箱: user@example.com"
    if (preg_match('/充值邮箱[:\s]+([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/', $orderInfo, $matches)) {
        return $matches[1];
    }

    // 格式2: "recharge_email: user@example.com"
    if (preg_match('/recharge_email[:\s]+([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/i', $orderInfo, $matches)) {
        return $matches[1];
    }

    // 如果找不到，回退到购买邮箱
    if (!empty($orderData['email'])) {
        return $orderData['email'];
    }

    throw new Exception('无法提取充值邮箱');
}

/**
 * 充值到第三方平台
 */
function rechargeToPlatform($email, $amount) {
    $apiUrl = 'https://target-platform.com/api/recharge';

    $params = [
        'email' => $email,  // ← 使用提取的充值邮箱
        'amount' => $amount,
        'timestamp' => time()
    ];

    // ... 发送请求逻辑
}
```

### 4.3 完整数据流

```
用户购买流程:
1. 访问 /buy/1
2. 填写购买邮箱: buyer@example.com
3. 填写充值邮箱: user@example.com  ← 专门的充值邮箱字段
4. 支付成功

订单数据:
{
    "order_sn": "ABC123",
    "email": "buyer@example.com",           ← 购买邮箱（接收通知）
    "order_info": "充值邮箱: user@example.com",  ← 充值邮箱
    ...
}

API回调数据:
{
    "order_sn": "ABC123",
    "email": "buyer@example.com",
    "order_info": "充值邮箱: user@example.com",  ← 从这里提取
    ...
}

你的API处理:
$rechargeEmail = extractRechargeEmail($data);
// 结果: user@example.com

发送给目标平台:
{
    "email": "user@example.com",  // ← 充值邮箱
    "amount": 100.00
}

发送通知邮件:
收件人: buyer@example.com  // ← 购买邮箱
```

---

## 五、方案3: 同时传递购买邮箱和充值账号

### 5.1 适用场景

- 目标平台需要账号（非邮箱）
- 但你也需要邮箱发送通知
- 需要同时记录购买者和充值账号

### 5.2 实现方式

#### 步骤1: 配置商品

```
商品管理 → 编辑商品 → 其他输入框配置
填写:
account=充值账号=true
recharge_email=充值邮箱=false
```

#### 步骤2: API同时传递两个字段

```php
<?php
/**
 * 充值API - 同时传递账号和邮箱
 */
header('Content-Type: application/json');

// 接收回调数据
$input = file_get_contents('php://input');
$data = json_decode($input, true);

// ⭐ 提取充值账号
$account = extractAccount($data);

// ⭐ 获取购买邮箱（用于通知）
$buyerEmail = $data['email'];

// ⭐ 提取充值邮箱（可选）
$rechargeEmail = extractRechargeEmail($data);

// 记录完整信息
file_put_contents(
    '/var/www/recharge-api/logs/hook_' . date('Y-m-d') . '.log',
    date('Y-m-d H:i:s') . " - Order: {$data['order_sn']}, Account: {$account}, BuyerEmail: {$buyerEmail}, RechargeEmail: {$rechargeEmail}\n",
    FILE_APPEND
);

try {
    // ⭐⭐⭐ 调用充值API，同时传递账号和邮箱
    $result = rechargeToPlatform($account, $rechargeEmail, $data['actual_price']);

    if ($result['success']) {
        // 通知购买邮箱
        sendNotificationEmail($buyerEmail, $result, $account);

        echo json_encode([
            'status' => 'success',
            'account' => $account,
            'recharge_email' => $rechargeEmail,
            'buyer_email' => $buyerEmail
        ]);
    }

} catch (Exception $e) {
    http_response_code(500);
    echo json_encode(['error' => $e->getMessage()]);
}

/**
 * 充值到第三方平台（传递账号和邮箱）
 */
function rechargeToPlatform($account, $email, $amount) {
    $apiUrl = 'https://target-platform.com/api/recharge';

    // ⭐ 同时传递账号和邮箱
    $params = [
        'account' => $account,      // 充值账号（用户名/ID）
        'email' => $email,          // 充值邮箱（可能用于验证）
        'amount' => $amount,
        'timestamp' => time(),
        'order_id' => $GLOBALS['data']['order_sn']
    ];

    // 发送请求
    $ch = curl_init($apiUrl);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($params));
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_HTTPHEADER, [
        'Content-Type: application/json',
        'Authorization: Bearer YOUR_API_KEY'
    ]);

    $response = curl_exec($ch);
    curl_close($ch);

    return json_decode($response, true);
}

/**
 * 提取充值账号
 */
function extractAccount($orderData) {
    $orderInfo = $orderData['order_info'] ?? '';

    if (preg_match('/充值账号[:\s]+([^\s\n]+)/', $orderInfo, $matches)) {
        return $matches[1];
    }

    throw new Exception('无法提取充值账号');
}

/**
 * 提取充值邮箱（可选）
 */
function extractRechargeEmail($orderData) {
    $orderInfo = $orderData['order_info'] ?? '';

    if (preg_match('/充值邮箱[:\s]+([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/', $orderInfo, $matches)) {
        return $matches[1];
    }

    // 如果没有填写充值邮箱，返回购买邮箱
    return $orderData['email'] ?? '';
}
```

### 5.3 完整数据流

```
用户购买流程:
1. 填写购买邮箱: buyer@example.com
2. 填写充值账号: user123
3. 填写充值邮箱: user@example.com (可选)

API回调数据:
{
    "email": "buyer@example.com",
    "order_info": "充值账号: user123\n充值邮箱: user@example.com"
}

你的API处理:
$account = "user123";
$buyerEmail = "buyer@example.com";
$rechargeEmail = "user@example.com";

发送给目标平台:
{
    "account": "user123",           // 充值账号
    "email": "user@example.com",    // 充值邮箱
    "amount": 100.00
}

发送通知:
收件人: buyer@example.com  ← 购买者
内容: 充值账号 user123 已成功充值
```

---

## 六、实际应用案例

### 案例1: ChatGPT Plus 充值

**特点**: 使用邮箱作为用户标识

**配置方式**:
```
方案1: 直接使用购买邮箱
无需配置自定义输入框
```

**API实现**:
```php
// 接收回调
$chatgptEmail = $data['email'];  // 直接使用邮箱

// 调用OpenAI充值API
$result = rechargeChatGPT($chatgptEmail, $amount);

function rechargeChatGPT($email, $amount) {
    $apiUrl = 'https://api.openai.com/v1/plus/recharge';

    $params = [
        'email' => $email,  // ← ChatGPT账号邮箱
        'amount' => $amount
    ];

    // 发送请求...
}
```

---

### 案例2: 游戏代练充值

**特点**: 需要游戏账号 + 邮箱通知

**配置方式**:
```
account=游戏账号=true
server_id=服务器ID=true
```

**API实现**:
```php
// 提取游戏账号
$gameAccount = extractField($data['order_info'], '游戏账号');
$serverId = extractField($data['order_info'], '服务器ID');
$buyerEmail = $data['email'];

// 调用游戏充值API
$result = rechargeGameAccount($gameAccount, $serverId, $amount);

function rechargeGameAccount($account, $serverId, $amount) {
    $apiUrl = 'https://game-platform.com/api/recharge';

    $params = [
        'account' => $account,     // 游戏账号
        'server_id' => $serverId,  // 服务器ID
        'amount' => $amount
    ];

    // 发送请求...
}

// 通知购买者
mail($buyerEmail, '充值成功', "游戏账号 {$gameAccount} 已充值成功");
```

---

### 案例3: VPN服务充值

**特点**: 需要用户名 + 邮箱

**配置方式**:
```
username=VPN用户名=true
recharge_email=充值邮箱=false
```

**API实现**:
```php
// 提取VPN用户名
$vpnUsername = extractField($data['order_info'], 'VPN用户名');
$rechargeEmail = extractField($data['order_info'], '充值邮箱') ?: $data['email'];

// 调用VPN充值API
$result = rechargeVPN($vpnUsername, $rechargeEmail, $amount);

function rechargeVPN($username, $email, $amount) {
    $apiUrl = 'https://vpn-service.com/api/recharge';

    $params = [
        'username' => $username,  // VPN用户名
        'email' => $email,        // 关联邮箱
        'amount' => $amount
    ];

    // 发送请求...
}
```

---

## 七、常见问题

### Q1: 用户填写的邮箱和目标平台邮箱不一致怎么办?

**解决方案**: 使用方案2（自定义输入框）
```
配置: recharge_email=充值邮箱=true

用户购买时:
- 购买邮箱: buyer@example.com (接收订单通知)
- 充值邮箱: user@example.com (实际充值的账号)
```

### Q2: 如何验证邮箱格式?

**在API端验证**:
```php
function validateEmail($email) {
    if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
        throw new Exception('邮箱格式不正确');
    }

    // 验证域名
    $domain = substr(strrchr($email, "@"), 1);
    if (!checkdnsrr($domain, 'MX')) {
        throw new Exception('邮箱域名不存在');
    }

    return true;
}
```

### Q3: 能否同时充值多个邮箱?

**配置多个邮箱字段**:
```
recharge_email1=充值邮箱1=true
recharge_email2=充值邮箱2=false
recharge_email3=充值邮箱3=false
```

**API处理**:
```php
$email1 = extractField($data['order_info'], '充值邮箱1');
$email2 = extractField($data['order_info'], '充值邮箱2');
$email3 = extractField($data['order_info'], '充值邮箱3');

// 批量充值
foreach ([$email1, $email2, $email3] as $email) {
    if (!empty($email)) {
        rechargeToPlatform($email, $amount);
    }
}
```

---

## 八、推荐方案选择

### 决策流程图

```
目标平台用什么作为用户标识?
    ↓
┌─────────────────────────────────────┐
│ 邮箱?                              │ → 使用方案1
│ ChatGPT, Midjourney, SaaS服务      │   (直接用购买邮箱)
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 用户名/ID?                         │ → 使用方案2
│ 游戏、VPN、虚拟货币                │   (配置账号输入框)
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 需要邮箱+账号?                      │ → 使用方案3
│ 需要邮箱验证的平台                  │   (同时传递两个字段)
└─────────────────────────────────────┘
```

---

## 九、快速配置示例

### 场景1: 目标平台用邮箱（最简单）

**商品配置**: 留空

**API代码**:
```php
$email = $data['email'];  // 直接使用
recharge($email, $amount);
```

---

### 场景2: 目标平台用账号（标准）

**商品配置**:
```
account=充值账号=true
```

**API代码**:
```php
$account = extractField($data['order_info'], '充值账号');
recharge($account, $amount);
```

---

### 场景3: 需要单独的充值邮箱

**商品配置**:
```
recharge_email=充值邮箱=true
```

**API代码**:
```php
$rechargeEmail = extractField($data['order_info'], '充值邮箱');
$buyerEmail = $data['email'];  // 购买邮箱
recharge($rechargeEmail, $amount);
notify($buyerEmail);  // 通知购买者
```

---

## 十、总结

### 核心要点

| 方案 | 配置 | API提取 | 发送给目标平台 |
|------|------|---------|---------------|
| **方案1** | 留空 | `$data['email']` | `{"email": "user@example.com"}` |
| **方案2** | `account=充值账号=true` | `extractField('充值账号')` | `{"account": "user123"}` |
| **方案3** | `recharge_email=充值邮箱=true` | `extractField('充值邮箱')` | `{"email": "user@example.com"}` |

### 推荐做法

1. **如果目标平台用邮箱**: 使用方案1，最简单
2. **如果目标平台用账号**: 使用方案2，标准做法
3. **需要邮箱验证**: 使用方案3，同时传递

---

**文档版本**: v1.0
**最后更新**: 2025-01-01
**相关文档**: 充值账号(userId)获取与流转完整指南.md, 自动发货与API回调充值完整指南.md
