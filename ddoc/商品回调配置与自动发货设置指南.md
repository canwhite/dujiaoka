# 商品回调配置与自动发货设置指南

## 一、核心问题

**Q: 配置商品的回调事件是在当前项目中配置吗？**
**A: 是的,在当前独角兽卡网项目中配置,但实际充值逻辑在独立的API服务中执行。**

---

## 二、配置位置详解

### 2.1 回调事件配置位置

**方式1: 后台管理界面配置** ⭐ 推荐

```
后台管理 → 商品管理 → 编辑商品 → 回调事件
```

在 **"回调事件"** 输入框中填写:
```
https://your-api.com/recharge
```

**方式2: 数据库直接配置**

```sql
UPDATE goods
SET api_hook = 'https://your-api.com/recharge'
WHERE id = 1;
```

**配置存储位置**:
- 表名: `goods`
- 字段名: `api_hook`
- 位置: 独角兽卡网项目数据库

---

### 2.2 自动发货设置

**Q: 可以在配置页面设置自动发货吗？**

**A: 可以!** 有以下几种方式:

#### 方式1: 后台管理界面 ⭐ 推荐

```
后台管理 → 商品管理 → 编辑商品
```

找到 **"商品类型"** 或 **"发货方式"** 选项:
- 选择 **"自动发货"**
- 不选择 **"人工处理"**

#### 方式2: 数据库配置

```sql
UPDATE goods
SET type = 1  -- 1 = 自动发货, 2 = 人工处理
WHERE id = 1;
```

**字段说明**:
```php
// app/Model/Order.php
const AUTOMATIC_DELIVERY = 1;  // 自动发货
const MANUAL_HANDLING = 2;      // 人工处理
```

---

## 三、完整配置流程

### 步骤1: 配置商品为自动发货

**后台操作**:
1. 登录后台管理
2. 进入 **商品管理**
3. 点击要配置的商品 **编辑**
4. 找到 **"商品类型"** 选项
5. 选择 **"自动发货"**
6. 保存

**或使用SQL**:
```sql
UPDATE goods
SET type = 1
WHERE id = 1;  -- 替换为你的商品ID
```

### 步骤2: 配置API回调地址

**后台操作**:
1. 在同一个商品编辑页面
2. 找到 **"回调事件"** 或 **"API Hook"** 输入框
3. 填写你的API地址:
   ```
   https://your-api.com/recharge
   ```
4. 保存

**或使用SQL**:
```sql
UPDATE goods
SET api_hook = 'https://your-api.com/recharge'
WHERE id = 1;  -- 替换为你的商品ID
```

### 步骤3: 验证配置

```sql
-- 查看配置结果
SELECT
    id,
    gd_name,
    type,
    api_hook
FROM goods
WHERE id = 1;
```

**预期结果**:
```
 id | gd_name | type | api_hook
----+---------+------+------------------------------
  1 | 商品A   |    1 | https://your-api.com/recharge
```

---

## 四、工作原理

### 4.1 配置存储位置

**所有配置都在独角兽卡网项目中**:

```
独角兽卡网数据库 (dujiaoka)
│
├── goods 表
│   ├── id              - 商品ID
│   ├── gd_name         - 商品名称
│   ├── type            - 商品类型 (1=自动, 2=人工) ⭐
│   ├── api_hook        - 回调地址 ⭐
│   └── ...
```

### 4.2 执行流程

```
┌───────────────────────────────────────────────────┐
│  独角兽卡网项目                                    │
│  ┌────────────────────────────────────────────┐  │
│  │ 数据库配置                                  │  │
│  │ ├─ type = 1 (自动发货)                    │  │ ← 在这里配置
│  │ └─ api_hook = 'https://api.xxx.com/recharge'│  │ ← 在这里配置
│  └────────────────────────────────────────────┘  │
│                   ↓                               │
│  ┌────────────────────────────────────────────┐  │
│  │ 用户支付成功                               │  │
│  │ AlipayController@notifyUrl                 │  │
│  │        ↓                                  │  │
│  │ OrderProcessService@completedOrder         │  │
│  │        ↓                                  │  │
│  │ 读取商品配置                               │  │
│  │ ├─ if (type == 1)                         │  │ ← 读取配置
│  │ │     processAuto()                      │  │
│  │ └─ if (!empty(api_hook))                 │  │ ← 读取配置
│  │         ApiHook::dispatch($order)        │  │
│  └────────────────────────────────────────────┘  │
└──────────────────┬────────────────────────────────┘
                   ↓ POST 请求
┌───────────────────────────────────────────────────┐
│  独立的充值API服务                                 │
│  (你自己开发, 可以用任何语言)                       │
│  ┌────────────────────────────────────────────┐  │
│  │ 接收回调: /recharge                        │  │ ← 实际在这里执行
│  │ ├─ 解析订单数据                            │  │
│  │ ├─ 调用第三方充值API ⭐⭐⭐                 │  │ ← 充值逻辑
│  │ ├─ 处理充值结果                            │  │
│  │ └─ 发送通知邮件                            │  │
│  └────────────────────────────────────────────┘  │
└───────────────────────────────────────────────────┘
```

---

## 五、配置字段说明

### 5.1 goods 表关键字段

| 字段名 | 类型 | 说明 | 可选值 |
|--------|------|------|--------|
| **type** | int | 商品类型 | 1 = 自动发货<br>2 = 人工处理 |
| **api_hook** | string | API回调地址 | 完整的URL, 如 `https://api.xxx.com/recharge` |
| **gd_name** | string | 商品名称 | - |
| **id** | int | 商品ID | - |

### 5.2 字段在代码中的使用

**type 字段** (app/Service/OrderProcessService.php:90-96):
```php
if ($order->type == Order::AUTOMATIC_DELIVERY) {
    // 自动发货
    $completedOrder = $this->processAuto($order);
} else {
    // 人工处理
    $completedOrder = $this->processManual($order);
}
```

**api_hook 字段** (app/Jobs/ApiHook.php:200):
```php
$goodInfo = $this->goodsService->detail($this->order->goods_id);

if(empty($goodInfo->api_hook)){
    return;  // 没配置则跳过
}

// 使用配置的 API Hook
file_get_contents($goodInfo->api_hook, false, $context);
```

---

## 六、后台配置界面参考

### 6.1 商品编辑页面

通常包含以下字段:

```
┌─────────────────────────────────────────┐
│ 编辑商品                                 │
├─────────────────────────────────────────┤
│ 商品名称: [_________________________]   │
│ 商品价格: [_________________________]   │
│                                         │
│ 商品类型:  ⚪ 自动发货  ⚪ 人工处理      │ ← 设置这里
│                                         │
│ 回调事件: [https://api.xxx.com/recharge]│ ← 设置这里
│                                         │
│ 库存数量: [_________________________]   │
│                                         │
│         [ 保存 ]  [ 取消 ]              │
└─────────────────────────────────────────┘
```

### 6.2 不同主题的可能字段名

根据不同主题,字段名可能不同:
- **回调事件**: API Hook / 回调地址 / Webhook / 通知URL
- **商品类型**: 发货方式 / 订单类型 / 自动发货 / 处理方式

---

## 七、常见问题

### Q1: 配置后不生效怎么办?

**检查清单**:

1. ✅ 确认商品类型是否为"自动发货"
   ```sql
   SELECT id, gd_name, type FROM goods WHERE id = 1;
   -- type 应该是 1
   ```

2. ✅ 确认 api_hook 是否配置
   ```sql
   SELECT id, gd_name, api_hook FROM goods WHERE id = 1;
   -- api_hook 应该不为空
   ```

3. ✅ 确认 Laravel 队列是否运行
   ```bash
   ps aux | grep queue:work
   ```

4. ✅ 查看日志是否有错误
   ```bash
   tail -f storage/logs/laravel.log
   ```

### Q2: 可以部分商品自动发货,部分人工处理吗?

**可以!** 每个商品独立配置:

```sql
-- 商品A: 自动发货 + API回调
UPDATE goods SET type = 1, api_hook = 'https://api.xxx.com/recharge' WHERE id = 1;

-- 商品B: 人工处理
UPDATE goods SET type = 2, api_hook = NULL WHERE id = 2;

-- 商品C: 自动发货 + 无回调 (发卡密)
UPDATE goods SET type = 1, api_hook = NULL WHERE id = 3;
```

### Q3: 回调地址支持 HTTPS 吗?

**强烈建议使用 HTTPS!**

- ✅ 推荐: `https://your-api.com/recharge`
- ⚠️ 不推荐: `http://your-api.com/recharge` (不安全)

如果使用 HTTPS,确保:
1. SSL 证书有效
2. 证书未过期
3. 证书链完整

### Q4: 如何测试配置是否正确?

**测试步骤**:

1. 配置商品为自动发货
2. 配置 API 回调地址
3. 下单测试商品
4. 支付成功后:
   ```bash
   # 查看 Laravel 队列日志
   tail -f storage/logs/laravel.log | grep ApiHook

   # 查看你的 API 日志
   tail -f /var/www/recharge-api/logs/*.log
   ```

---

## 八、配置示例

### 示例1: Token 充值商品

```sql
-- 配置为自动发货 + API回调
UPDATE goods
SET
    type = 1,                                    -- 自动发货
    api_hook = 'https://api.myshop.com/recharge' -- 回调地址
WHERE id = 1;
```

**效果**:
- 用户支付成功 → 自动调用 API → 充值 Token → 通知用户

### 示例2: 卡密发货商品

```sql
-- 配置为自动发货 + 无回调
UPDATE goods
SET
    type = 1,        -- 自动发货
    api_hook = NULL  -- 不需要回调
WHERE id = 2;
```

**效果**:
- 用户支付成功 → 自动发送卡密

### 示例3: 人工处理商品

```sql
-- 配置为人工处理
UPDATE goods
SET
    type = 2,        -- 人工处理
    api_hook = NULL  -- 不需要回调
WHERE id = 3;
```

**效果**:
- 用户支付成功 → 管理员后台手动处理

---

## 九、总结

### 核心要点

| 配置项 | 配置位置 | 作用 |
|--------|---------|------|
| **自动发货** | 后台商品管理 → 商品类型 | 决定订单是自动处理还是人工处理 |
| **API回调** | 后台商品管理 → 回调事件 | 支付成功后调用的外部API地址 |

### 配置流程

```
1. 登录后台
   ↓
2. 商品管理 → 编辑商品
   ↓
3. 设置商品类型为"自动发货"  ← 配置在当前项目
   ↓
4. 填写回调事件URL           ← 配置在当前项目
   ↓
5. 保存
   ↓
6. 用户支付后,自动回调到配置的URL  ← 执行在独立API服务
```

### 优势

- ✅ 配置简单,后台界面操作
- ✅ 不需要修改代码
- ✅ 支持每个商品独立配置
- ✅ 升级项目不影响配置

---

## 十、SQL 脚本批量配置指南

### 10.1 单个商品配置 SQL

**配置为自动发货 + API 回调**:
```sql
-- 示例: 配置商品ID为1的商品
UPDATE goods
SET
    type = 1,                                    -- 自动发货
    api_hook = 'https://api.myshop.com/recharge' -- 你的回调地址
WHERE id = 1;

-- 验证配置
SELECT
    id,
    gd_name AS '商品名称',
    CASE type
        WHEN 1 THEN '自动发货'
        WHEN 2 THEN '人工处理'
        ELSE '未知'
    END AS '发货方式',
    api_hook AS '回调地址'
FROM goods
WHERE id = 1;
```

---

### 10.2 批量配置多个商品

**场景1: 所有商品统一配置**
```sql
-- 所有商品都设置为自动发货 + 统一回调地址
UPDATE goods
SET
    type = 1,
    api_hook = 'https://api.myshop.com/recharge'
WHERE 1=1;

-- 查看所有商品配置
SELECT
    id,
    gd_name AS '商品名称',
    CASE type
        WHEN 1 THEN '自动发货'
        WHEN 2 THEN '人工处理'
        ELSE '未知'
    END AS '发货方式',
    api_hook AS '回调地址'
FROM goods
ORDER BY id;
```

**场景2: 指定多个商品ID配置**
```sql
-- 配置商品ID为 1, 2, 3 的商品
UPDATE goods
SET
    type = 1,
    api_hook = 'https://api.myshop.com/recharge'
WHERE id IN (1, 2, 3);

-- 验证
SELECT id, gd_name, type, api_hook
FROM goods
WHERE id IN (1, 2, 3);
```

**场景3: 按商品类别配置**
```sql
-- 假设商品有 category_id 字段,配置"充值类"商品
UPDATE goods
SET
    type = 1,
    api_hook = 'https://api.myshop.com/recharge'
WHERE category_id = 1;  -- 充值类类别ID

-- 验证
SELECT id, gd_name, type, api_hook
FROM goods
WHERE category_id = 1;
```

**场景4: 按商品名称关键词配置**
```sql
-- 配置所有名称包含"Token"的商品
UPDATE goods
SET
    type = 1,
    api_hook = 'https://api.myshop.com/recharge'
WHERE gd_name LIKE '%Token%';

-- 验证
SELECT id, gd_name, type, api_hook
FROM goods
WHERE gd_name LIKE '%Token%';
```

---

### 10.3 创建可复用的存储过程

**存储过程1: 配置单个商品**
```sql
DELIMITER $$

CREATE PROCEDURE config_goods_auto_recharge(
    IN p_goods_id INT,
    IN p_api_hook VARCHAR(255)
)
BEGIN
    -- 更新商品配置
    UPDATE goods
    SET
        type = 1,
        api_hook = p_api_hook
    WHERE id = p_goods_id;

    -- 显示配置结果
    SELECT
        id,
        gd_name AS '商品名称',
        CASE type
            WHEN 1 THEN '自动发货'
            WHEN 2 THEN '人工处理'
        END AS '发货方式',
        api_hook AS '回调地址',
        '配置成功' AS '状态'
    FROM goods
    WHERE id = p_goods_id;

END$$

DELIMITER ;

-- 使用示例
CALL config_goods_auto_recharge(1, 'https://api.myshop.com/recharge');
CALL config_goods_auto_recharge(2, 'https://api.myshop.com/recharge');
```

**存储过程2: 批量配置多个商品**
```sql
DELIMITER $$

CREATE PROCEDURE config_batch_goods_auto_recharge(
    IN p_goods_ids VARCHAR(1000),  -- 逗号分隔的ID,如 "1,2,3,4,5"
    IN p_api_hook VARCHAR(255)
)
BEGIN
    -- 更新商品配置
    SET @sql = CONCAT(
        'UPDATE goods SET type = 1, api_hook = ?, ',
        'WHERE id IN (', p_goods_ids, ')'
    );

    PREPARE stmt FROM @sql;
    EXECUTE stmt USING p_api_hook;
    DEALLOCATE PREPARE stmt;

    -- 显示配置结果
    SET @sql = CONCAT(
        'SELECT id, gd_name, type, api_hook FROM goods ',
        'WHERE id IN (', p_goods_ids, ')'
    );

    PREPARE stmt FROM @sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;

END$$

DELIMITER ;

-- 使用示例
CALL config_batch_goods_auto_recharge('1,2,3,4,5', 'https://api.myshop.com/recharge');
```

---

### 10.4 配置管理 SQL 脚本

**完整的管理脚本**:

```sql
-- ========================================
-- 商品配置管理脚本
-- 创建日期: 2025-01-01
-- 说明: 用于批量配置商品的自动发货和API回调
-- ========================================

-- 1. 查看当前所有商品配置
SELECT
    id AS 'ID',
    gd_name AS '商品名称',
    CASE type
        WHEN 1 THEN '✅ 自动发货'
        WHEN 2 THEN '⚙️ 人工处理'
        ELSE '❓ 未知'
    END AS '发货方式',
    api_hook AS 'API回调地址',
    updated_at AS '更新时间'
FROM goods
ORDER BY id;

-- 2. 查看已配置API回调的商品
SELECT
    id AS 'ID',
    gd_name AS '商品名称',
    api_hook AS 'API回调地址'
FROM goods
WHERE api_hook IS NOT NULL
AND api_hook != ''
ORDER BY id;

-- 3. 查看未配置API回调的商品
SELECT
    id AS 'ID',
    gd_name AS '商品名称',
    type AS '类型'
FROM goods
WHERE api_hook IS NULL
OR api_hook = ''
ORDER BY id;

-- 4. 统计配置情况
SELECT
    COUNT(*) AS '总商品数',
    SUM(CASE WHEN type = 1 THEN 1 ELSE 0 END) AS '自动发货',
    SUM(CASE WHEN type = 2 THEN 1 ELSE 0 END) AS '人工处理',
    SUM(CASE WHEN api_hook IS NOT NULL AND api_hook != '' THEN 1 ELSE 0 END) AS '已配置回调'
FROM goods;

-- ========================================
-- 配置示例 (请根据实际情况修改)
-- ========================================

-- 示例1: 配置单个商品
-- UPDATE goods SET type = 1, api_hook = 'https://api.myshop.com/recharge' WHERE id = 1;

-- 示例2: 批量配置
-- UPDATE goods SET type = 1, api_hook = 'https://api.myshop.com/recharge' WHERE id IN (1,2,3);

-- 示例3: 清除某个商品的回调配置
-- UPDATE goods SET api_hook = NULL WHERE id = 1;

-- 示例4: 批量清除回调配置
-- UPDATE goods SET api_hook = NULL WHERE id IN (1,2,3);

-- 示例5: 修改商品为人工处理
-- UPDATE goods SET type = 2 WHERE id = 1;
```

---

### 10.5 实用的 SQL 查询

**查询1: 查找所有自动发货的商品**
```sql
SELECT
    id,
    gd_name,
    actual_price,
    in_stock,
    api_hook
FROM goods
WHERE type = 1
ORDER BY id;
```

**查询2: 查找所有人工处理的商品**
```sql
SELECT
    id,
    gd_name,
    actual_price,
    in_stock
FROM goods
WHERE type = 2
ORDER BY id;
```

**查询3: 查找配置了特定回调地址的商品**
```sql
SELECT
    id,
    gd_name,
    api_hook
FROM goods
WHERE api_hook LIKE '%myshop.com%'
ORDER BY id;
```

**查询4: 导出商品配置 (用于备份)**
```sql
SELECT
    id,
    gd_name,
    type,
    api_hook,
    actual_price,
    in_stock,
    created_at,
    updated_at
FROM goods
ORDER BY id
INTO OUTFILE '/tmp/goods_config_backup.csv'
FIELDS TERMINATED BY ','
ENCLOSED BY '"'
LINES TERMINATED BY '\n';
```

---

### 10.6 使用脚本的最佳实践

### 安全操作步骤

**1. 备份现有配置**
```sql
-- 创建备份表
CREATE TABLE goods_backup_20250101 AS SELECT * FROM goods;

-- 或导出数据
SELECT * FROM goods INTO OUTFILE '/tmp/goods_backup.sql';
```

**2. 在测试环境验证**
```sql
-- 先在测试环境执行
-- 验证结果无误后再在生产环境执行
```

**3. 使用事务保护**
```sql
-- 开始事务
START TRANSACTION;

-- 执行更新
UPDATE goods SET type = 1, api_hook = 'https://api.xxx.com/recharge' WHERE id = 1;

-- 检查结果
SELECT id, gd_name, type, api_hook FROM goods WHERE id = 1;

-- 如果结果正确,提交事务
-- COMMIT;

-- 如果结果错误,回滚事务
-- ROLLBACK;
```

**4. 分批处理大量数据**
```sql
-- 每次更新100条,避免锁表时间过长
UPDATE goods
SET type = 1, api_hook = 'https://api.xxx.com/recharge'
WHERE id >= 1 AND id < 100;

UPDATE goods
SET type = 1, api_hook = 'https://api.xxx.com/recharge'
WHERE id >= 100 AND id < 200;

-- 依此类推...
```

---

### 10.7 常见配置场景脚本

**场景1: 新商品初始化配置**
```sql
-- 假设刚添加了新商品,ID从100到105
UPDATE goods
SET
    type = 1,
    api_hook = 'https://api.myshop.com/recharge'
WHERE id BETWEEN 100 AND 105;

-- 验证
SELECT id, gd_name, type, api_hook
FROM goods
WHERE id BETWEEN 100 AND 105;
```

**场景2: 临时关闭某个商品的API回调**
```sql
-- 临时关闭,不清除配置
UPDATE goods
SET type = 2  -- 改为人工处理
WHERE id = 1;

-- 恢复时
UPDATE goods
SET type = 1  -- 改回自动发货
WHERE id = 1;
```

**场景3: 迁移到新的API地址**
```sql
-- 批量更换API地址
UPDATE goods
SET api_hook = 'https://new-api.myshop.com/recharge'
WHERE api_hook = 'https://old-api.myshop.com/recharge';

-- 验证
SELECT id, gd_name, api_hook
FROM goods
WHERE api_hook LIKE '%new-api.myshop.com%';
```

**场景4: 按条件批量配置**
```sql
-- 配置所有价格大于100的商品为人工处理
UPDATE goods
SET type = 2
WHERE actual_price > 100;

-- 配置所有价格小于等于100的商品为自动发货
UPDATE goods
SET type = 1
WHERE actual_price <= 100;
```

---

### 10.8 完整配置文件示例

创建文件 `/var/www/dujiaoka/sql/goods_config.sql`:

```sql
-- ========================================
-- 商品自动发货与API回调配置脚本
-- ========================================

-- 使用说明:
-- 1. 修改下面的配置项
-- 2. 取消需要执行的SQL注释
-- 3. 执行脚本: mysql -u root -p dujiaoka < goods_config.sql

-- ========================================
-- 配置项
-- ========================================

-- 设置回调地址
SET @api_hook_url = 'https://api.myshop.com/recharge';

-- 设置要配置的商品ID列表
SET @goods_ids = '1,2,3,4,5';

-- ========================================
-- 执行配置
-- ========================================

-- 方式1: 配置指定的商品ID
-- UPDATE goods
-- SET type = 1, api_hook = @api_hook_url
-- WHERE id IN (@goods_ids);

-- 方式2: 配置所有商品
-- UPDATE goods
-- SET type = 1, api_hook = @api_hook_url;

-- 方式3: 配置特定类别的商品
-- UPDATE goods
-- SET type = 1, api_hook = @api_hook_url
-- WHERE category_id = 1;

-- ========================================
-- 验证配置
-- ========================================

-- 查看配置结果
SELECT
    id,
    gd_name AS '商品名称',
    CASE type
        WHEN 1 THEN '✅ 自动发货'
        WHEN 2 THEN '⚙️ 人工处理'
    END AS '发货方式',
    api_hook AS 'API回调地址'
FROM goods
WHERE 1=1
-- AND id IN (@goods_ids)  -- 如果只查看特定商品,取消此注释
ORDER BY id;
```

**执行脚本**:
```bash
# 方式1: 直接执行
mysql -u root -p dujiaoka < /var/www/dujiaoka/sql/goods_config.sql

# 方式2: 登录后执行
mysql -u root -p
USE dujiaoka;
SOURCE /var/www/dujiaoka/sql/goods_config.sql;

# 方式3: 命令行执行单条SQL
mysql -u root -p dujiaoka -e "UPDATE goods SET type = 1, api_hook = 'https://api.myshop.com/recharge' WHERE id = 1;"
```

---

### 10.9 快速参考卡片

```sql
-- ⚡ 快速配置单个商品
UPDATE goods SET type = 1, api_hook = 'https://api.xxx.com/recharge' WHERE id = 1;

-- ⚡ 批量配置多个商品
UPDATE goods SET type = 1, api_hook = 'https://api.xxx.com/recharge' WHERE id IN (1,2,3);

-- ⚡ 清除回调配置
UPDATE goods SET api_hook = NULL WHERE id = 1;

-- ⚡ 改为人工处理
UPDATE goods SET type = 2 WHERE id = 1;

-- ⚡ 查看所有配置
SELECT id, gd_name, type, api_hook FROM goods;

-- ⚡ 查看配置统计
SELECT
    COUNT(*) AS '总数',
    SUM(CASE WHEN type=1 THEN 1 ELSE 0 END) AS '自动发货',
    SUM(CASE WHEN type=2 THEN 1 ELSE 0 END) AS '人工处理'
FROM goods;
```

---

**文档版本**: v1.1
**最后更新**: 2025-01-01
**相关文档**: 自动发货与API回调充值完整指南.md
