# 外部网站跳转购买页面-邮箱自动填充改造方案

## 一、业务场景

**场景描述**:
- 用户在第三方网站（需要充值的目标网站）点击"充值"按钮
- 跳转到独角兽卡网购买页面
- **URL中携带用户的邮箱参数**
- 购买页面的邮箱输入框**自动填充**该邮箱
- 用户直接支付，无需手动填写邮箱

---

## 二、改造方案总览

### 2.1 改造涉及的文件

| 文件 | 改造类型 | 说明 |
|------|---------|------|
| `app/Http/Controllers/Home/HomeController.php` | ⭐ 修改 | 接收URL参数并传递给视图 |
| `resources/views/luna/static_pages/buy.blade.php` | ⭐ 修改 | 邮箱输入框自动填充 |
| `routes/common/web.php` | 查看 | 确认路由支持可选参数 |

### 2.2 完整流程图

```
第三方网站
    ↓ 点击充值按钮
跳转URL: https://dujiaoka.com/buy/1?email=user@example.com
    ↓
Laravel路由解析
    ↓
HomeController@buy() 接收email参数
    ↓
传递给视图: $formatGoods->preset_email = 'user@example.com'
    ↓
buy.blade.php 视图渲染
    ↓
邮箱input框自动填充: value="user@example.com"
    ↓
用户直接支付
```

---

## 三、详细改造步骤

### 步骤1: 修改控制器 - 接收email参数

**文件**: `app/Http/Controllers/Home/HomeController.php:65`

#### 原始代码
```php
public function buy(int $id)
{
    try {
        $goods = $this->goodsService->detail($id);
        // ... 其他代码
        $formatGoods = $this->goodsService->format($goods);
        // ...
        return $this->render('static_pages/buy', $formatGoods, $formatGoods->gd_name);
    } catch (RuleValidationException $ruleValidationException) {
        return $this->err($ruleValidationException->getMessage());
    }
}
```

#### ⭐ 改造后代码

```php
public function buy(int $id, Request $request)  // ← 添加Request参数
{
    try {
        $goods = $this->goodsService->detail($id);
        $this->goodsService->validatorGoodsStatus($goods);

        // 有没有优惠码可以展示
        if (count($goods->coupon)) {
            $goods->open_coupon = 1;
        }

        $formatGoods = $this->goodsService->format($goods);

        // ⭐⭐⭐ 获取URL中的email参数（如果有）
        $presetEmail = $request->input('email', '');
        // 验证邮箱格式
        if (!empty($presetEmail) && filter_var($presetEmail, FILTER_VALIDATE_EMAIL)) {
            $formatGoods->preset_email = $presetEmail;
        } else {
            $formatGoods->preset_email = '';
        }

        // 加载支付方式
        $client = Pay::PAY_CLIENT_PC;
        if (app('Jenssegers\Agent')->isMobile()) {
            $client = Pay::PAY_CLIENT_MOBILE;
        }

        $formatGoods->payways = $this->payService->pays($client);

        return $this->render('static_pages/buy', $formatGoods, $formatGoods->gd_name);

    } catch (RuleValidationException $ruleValidationException) {
        return $this->err($ruleValidationException->getMessage());
    }
}
```

#### 关键改动说明

```php
// 1. 添加Request参数
public function buy(int $id, Request $request)

// 2. 获取URL中的email参数
$presetEmail = $request->input('email', '');

// 3. 验证邮箱格式
if (!empty($presetEmail) && filter_var($presetEmail, FILTER_VALIDATE_EMAIL)) {
    $formatGoods->preset_email = $presetEmail;  // 传递给视图
}

// 4. 如果URL没有email或格式不对，则为空字符串
$formatGoods->preset_email = '';
```

---

### 步骤2: 修改视图 - 邮箱输入框自动填充

**文件**: `resources/views/luna/static_pages/buy.blade.php:125`

#### 原始代码
```blade
<div class="entry">
    <span class="l-msg">{{ __('luna.buy_email') }}：</span>
    <label class="input">
        <input type="text" name="email"
               required lay-verify="required|email"
               placeholder="{{ __('luna.buy_email_tips') }}">
    </label>
</div>
```

#### ⭐ 改造后代码

```blade
<div class="entry">
    <span class="l-msg">{{ __('luna.buy_email') }}：</span>
    <label class="input">
        <input type="text" name="email"
               required lay-verify="required|email"
               placeholder="{{ __('luna.buy_email_tips') }}"
               value="{{ $preset_email ?? '' }}"  {{-- ⭐ 自动填充 --}}
               @if(!empty($preset_email)) readonly @endif  {{-- ⭐ 可选：设为只读 --}}
               >
    </label>
    @if(!empty($preset_email))
    <p class="layui-word-aux">
        <svg style="vertical-align: middle;" t="1602941112468" class="icon" viewBox="0 0 1024 1024" width="16" height="16">
            <path fill="#009688" d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm193.5 301.7l-210.6 292c-12.7 17.7-39 17.7-51.7 0L318.5 484.9c-3.8-5.3 0-12.7 6.5-12.7h46.9c10.2 0 19.9 4.9 25.9 13.3l71.2 98.8 157.2-218c6-8.3 15.6-13.3 25.9-13.3H699c6.5 0 10.3 7.4 6.5 12.7z"/>
        </svg>
        <span style="color: #009688; margin-left: 5px;">已从目标网站自动填充充值邮箱</span>
    </p>
    @endif
</div>
```

#### 关键改动说明

```blade
{{!-- 1. 自动填充邮箱 --}}
value="{{ $preset_email ?? '' }}"

{{!-- 2. 可选：设为只读（防止用户修改） --}}
@if(!empty($preset_email)) readonly @endif

{{!-- 3. 可选：显示提示信息 --}}
@if(!empty($preset_email))
    <p>已从目标网站自动填充充值邮箱</p>
@endif
```

---

### 步骤3: 其他主题同步修改（可选）

如果你使用的是其他主题，也需要同步修改：

#### Hyper主题
**文件**: `resources/views/hyper/static_pages/buy.blade.php`

```blade
<input type="email" name="email"
       class="form-control"
       placeholder="请输入邮箱"
       value="{{ $preset_email ?? '' }}"
       @if(!empty($preset_email)) readonly @endif
       required>
```

#### Unicorn主题
**文件**: `resources/views/unicorn/static_pages/buy.blade.php`

```blade
<input type="text" name="email"
       class="form-control"
       placeholder="{{ __('dujiaoka.buy_email_tips') }}"
       value="{{ $preset_email ?? '' }}"
       @if(!empty($preset_email)) readonly @endif
       required>
```

---

## 四、外部网站跳转方式

### 方式1: 直接URL跳转

```html
<!-- 第三方网站的充值按钮 -->
<a href="https://dujiaoka.com/buy/1?email=user@example.com">
    点击充值
</a>
```

### 方式2: JavaScript跳转

```javascript
// 获取当前登录用户的邮箱
const userEmail = getCurrentUserEmail(); // user@example.com

// 跳转到购买页面
window.location.href = `https://dujiaoka.com/buy/1?email=${userEmail}`;
```

### 方式3: 表单POST跳转

```html
<!-- 第三方网站的充值表单 -->
<form action="https://dujiaoka.com/buy/1" method="GET">
    <input type="hidden" name="email" value="user@example.com">
    <button type="submit">点击充值</button>
</form>
```

### 方式4: 动态生成URL（推荐）

```javascript
// 第三方网站JavaScript
function redirectToRecharge(goodsId, userEmail) {
    // 验证邮箱格式
    if (!userEmail || !validateEmail(userEmail)) {
        alert('请先登录或填写邮箱');
        return;
    }

    // 构建跳转URL
    const rechargeUrl = `https://dujiaoka.com/buy/${goodsId}?email=${encodeURIComponent(userEmail)}`;

    // 跳转
    window.open(rechargeUrl, '_blank');  // 新窗口打开
    // 或 window.location.href = rechargeUrl;  // 当前窗口跳转
}

// 使用示例
redirectToRecharge(1, 'user@example.com');
```

---

## 五、完整测试流程

### 5.1 测试步骤

1. **准备测试URL**
   ```
   https://dujiaoka.com/buy/1?email=test@example.com
   ```

2. **访问购买页面**
   - 直接在浏览器打开上述URL
   - 或从第三方网站点击跳转

3. **验证结果**
   - 邮箱输入框应该自动填充 `test@example.com`
   - 输入框可能是只读状态（如果设置了）
   - 显示"已从目标网站自动填充充值邮箱"提示

4. **提交订单**
   - 直接点击支付按钮
   - 验证订单创建成功
   - 验证订单邮箱为 `test@example.com`

### 5.2 边界测试

| 测试场景 | URL | 预期结果 |
|---------|-----|---------|
| **正常邮箱** | `?email=user@example.com` | 自动填充 |
| **无email参数** | `/buy/1` | 空白，用户手动填写 |
| **无效邮箱** | `?email=invalid-email` | 空白，用户手动填写 |
| **空邮箱** | `?email=` | 空白，用户手动填写 |
| **特殊字符** | `?email=user+tag@example.com` | 自动填充（有效邮箱） |
| **中文邮箱** | `?email=用户@example.com` | 自动填充（如果支持） |

---

## 六、安全增强建议

### 6.1 验证邮箱格式

**控制器中添加更严格的验证**:

```php
public function buy(int $id, Request $request)
{
    $presetEmail = $request->input('email', '');

    // ⭐ 更严格的验证
    if (!empty($presetEmail)) {
        // 验证格式
        if (!filter_var($presetEmail, FILTER_VALIDATE_EMAIL)) {
            $presetEmail = '';
        }

        // 验证长度
        if (strlen($presetEmail) > 254) {  // RFC 5321
            $presetEmail = '';
        }

        // 可选：白名单域名验证
        // $allowedDomains = ['example.com', 'trusted.com'];
        // $domain = substr(strrchr($presetEmail, "@"), 1);
        // if (!in_array($domain, $allowedDomains)) {
        //     $presetEmail = '';
        // }
    }

    $formatGoods->preset_email = $presetEmail;

    // ... 其他代码
}
```

### 6.2 防止XSS攻击

**视图模板中转义输出**:

```blade
{{-- Laravel默认会转义，使用 e() 函数更安全 --}}
<input type="text" name="email"
       value="{{ e($preset_email ?? '') }}"
       >
```

### 6.3 添加token验证（可选）

**如果需要验证跳转来源**:

```php
// 第三方网站生成跳转链接
function generateRechargeUrl($goodsId, $userEmail) {
    $secret = 'your_shared_secret';
    $timestamp = time();
    $token = md5($goodsId . $userEmail . $timestamp . $secret);

    return "https://dujiaoka.com/buy/{$goodsId}?" .
           "email=" . urlencode($userEmail) .
           "&timestamp={$timestamp}" .
           "&token={$token}";
}

// 独角兽卡网验证token
public function buy(int $id, Request $request)
{
    $presetEmail = $request->input('email', '');
    $timestamp = $request->input('timestamp', '');
    $token = $request->input('token', '');

    // 验证token（可选，24小时有效期）
    if (!empty($token) && !empty($timestamp)) {
        $secret = 'your_shared_secret';
        $expectedToken = md5($id . $presetEmail . $timestamp . $secret);

        if ($token === $expectedToken && ($timestamp + 86400) > time()) {
            // Token验证通过
            $formatGoods->preset_email = $presetEmail;
        } else {
            // Token无效，忽略预设邮箱
            $formatGoods->preset_email = '';
        }
    } else {
        // 没有token，普通验证
        if (!empty($presetEmail) && filter_var($presetEmail, FILTER_VALIDATE_EMAIL)) {
            $formatGoods->preset_email = $presetEmail;
        } else {
            $formatGoods->preset_email = '';
        }
    }

    // ... 其他代码
}
```

---

## 七、高级功能

### 7.1 支持多个预设字段

如果需要预填充其他字段（如充值账号）：

```php
// 控制器
public function buy(int $id, Request $request)
{
    // 预设邮箱
    $formatGoods->preset_email = $request->input('email', '');

    // ⭐ 预设其他字段
    $formatGoods->preset_account = $request->input('account', '');
    $formatGoods->preset_server = $request->input('server', '');

    // ... 其他代码
}
```

```blade
{{-- 视图 --}}
<input type="text" name="account" value="{{ $preset_account ?? '' }}">
<input type="text" name="server" value="{{ $preset_server ?? '' }}">
```

**跳转URL**:
```
https://dujiaoka.com/buy/1?email=user@example.com&account=myname&server=1
```

### 7.2 URL参数加密（可选）

为了防止用户篡改URL参数：

```php
// 第三方网站生成加密URL
function generateEncryptedRechargeUrl($goodsId, $userEmail) {
    $secret = 'your_encryption_key';
    $data = json_encode([
        'email' => $userEmail,
        'timestamp' => time()
    ]);

    // 加密数据
    $encrypted = openssl_encrypt($data, 'AES-256-CBC', $secret, 0, '1234567890123456');
    $encrypted = base64_encode($encrypted);

    return "https://dujiaoka.com/buy/{$goodsId}?data=" . urlencode($encrypted);
}

// 独角兽卡网解密
public function buy(int $id, Request $request)
{
    $encryptedData = $request->input('data', '');
    $presetEmail = '';

    if (!empty($encryptedData)) {
        $secret = 'your_encryption_key';
        $decrypted = openssl_decrypt(
            base64_decode($encryptedData),
            'AES-256-CBC',
            $secret,
            0,
            '1234567890123456'
        );

        $data = json_decode($decrypted, true);

        // 验证时间戳（24小时内有效）
        if (isset($data['timestamp']) && ($data['timestamp'] + 86400) > time()) {
            $presetEmail = $data['email'] ?? '';
        }
    }

    $formatGoods->preset_email = $presetEmail;

    // ... 其他代码
}
```

---

## 八、用户体验优化

### 8.1 添加来源标识

显示用户从哪个网站跳转过来：

```php
// 控制器
public function buy(int $id, Request $request)
{
    $formatGoods->preset_email = $request->input('email', '');

    // ⭐ 获取来源
    $formatGoods->source = $request->input('source', '直接访问');

    // ... 其他代码
}
```

```blade
{{-- 视图 --}}
@if(!empty($preset_email))
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i>
        欢迎！您来自 <strong>{{ $source }}</strong>，
        充值邮箱已自动填充：<strong>{{ $preset_email }}</strong>
    </div>
@endif
```

**跳转URL**:
```
https://dujiaoka.com/buy/1?email=user@example.com&source=ChatGPT官网
```

### 8.2 一键修改功能

如果邮箱是预设的，允许用户一键清空修改：

```blade
<div class="entry">
    <span class="l-msg">{{ __('luna.buy_email') }}：</span>
    <label class="input">
        <input type="text" name="email"
               id="email-input"
               required lay-verify="required|email"
               placeholder="{{ __('luna.buy_email_tips') }}"
               value="{{ $preset_email ?? '' }}"
               @if(!empty($preset_email)) readonly @endif
               >
    </label>
    @if(!empty($preset_email))
    <button type="button" class="layui-btn layui-btn-xs layui-btn-primary" onclick="clearEmail()">
        <i class="fas fa-edit"></i> 修改邮箱
    </button>
    <script>
    function clearEmail() {
        document.getElementById('email-input').removeAttribute('readonly');
        document.getElementById('email-input').value = '';
        document.getElementById('email-input').focus();
    }
    </script>
    @endif
</div>
```

---

## 九、完整代码示例

### 改造后的HomeController.php

```php
<?php

namespace App\Http\Controllers\Home;

use App\Exceptions\RuleValidationException;
use App\Service\GoodsService;
use App\Service\PayService;
use App\Models\Pay;
use App\Http\Controllers\BaseController;
use Illuminate\Http\Request;

class HomeController extends BaseController
{
    /**
     * 购买页面
     *
     * @param int $id 商品ID
     * @param Request $request HTTP请求
     * @return \Illuminate\View\View
     */
    public function buy(int $id, Request $request)
    {
        try {
            // 获取商品信息
            $goods = $this->goodsService->detail($id);
            $this->goodsService->validatorGoodsStatus($goods);

            // 优惠码处理
            if (count($goods->coupon)) {
                $goods->open_coupon = 1;
            }

            $formatGoods = $this->goodsService->format($goods);

            // ⭐⭐⭐ 获取并验证预设邮箱
            $presetEmail = $request->input('email', '');
            if (!empty($presetEmail)) {
                // 验证邮箱格式
                if (filter_var($presetEmail, FILTER_VALIDATE_EMAIL) && strlen($presetEmail) <= 254) {
                    $formatGoods->preset_email = $presetEmail;
                } else {
                    $formatGoods->preset_email = '';
                }
            } else {
                $formatGoods->preset_email = '';
            }

            // ⭐ 获取来源（可选）
            $formatGoods->source = $request->input('source', '');

            // 加载支付方式
            $client = Pay::PAY_CLIENT_PC;
            if (app('Jenssegers\Agent')->isMobile()) {
                $client = Pay::PAY_CLIENT_MOBILE;
            }

            $formatGoods->payways = $this->payService->pays($client);

            return $this->render('static_pages/buy', $formatGoods, $formatGoods->gd_name);

        } catch (RuleValidationException $ruleValidationException) {
            return $this->err($ruleValidationException->getMessage());
        }
    }

    // ... 其他方法
}
```

### 改造后的buy.blade.php

```blade
<div class="entry">
    <span class="l-msg">{{ __('luna.buy_email') }}：</span>
    <label class="input">
        <input type="text" name="email"
               id="email-input"
               required lay-verify="required|email"
               placeholder="{{ __('luna.buy_email_tips') }}"
               value="{{ $preset_email ?? '' }}"
               @if(!empty($preset_email)) readonly @endif
               >
    </label>

    @if(!empty($preset_email))
    {{-- 修改按钮 --}}
    <button type="button" class="layui-btn layui-btn-xs layui-btn-warm" onclick="enableEmailEdit()">
        <i class="fas fa-edit"></i> 修改
    </button>

    {{-- 提示信息 --}}
    <p class="layui-word-aux" style="margin-top: 5px;">
        <svg style="vertical-align: middle;" t="1602941112468" class="icon" viewBox="0 0 1024 1024" width="14" height="14">
            <path fill="#009688" d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm193.5 301.7l-210.6 292c-12.7 17.7-39 17.7-51.7 0L318.5 484.9c-3.8-5.3 0-12.7 6.5-12.7h46.9c10.2 0 19.9 4.9 25.9 13.3l71.2 98.8 157.2-218c6-8.3 15.6-13.3 25.9-13.3H699c6.5 0 10.3 7.4 6.5 12.7z"/>
        </svg>
        <span style="color: #009688; margin-left: 5px;">
            已自动填充充值邮箱
            @if(!empty($source))
                (来自: {{ $source }})
            @endif
        </span>
    </p>

    <script>
    function enableEmailEdit() {
        var input = document.getElementById('email-input');
        input.removeAttribute('readonly');
        input.focus();
        input.select();
    }
    </script>
    @endif
</div>
```

---

## 十、部署清单

### 10.1 代码修改清单

- [ ] 修改 `app/Http/Controllers/Home/HomeController.php`
  - [ ] 添加 `Request $request` 参数
  - [ ] 添加邮箱验证逻辑
  - [ ] 传递 `$preset_email` 到视图

- [ ] 修改 `resources/views/luna/static_pages/buy.blade.php`
  - [ ] 添加 `value="{{ $preset_email ?? '' }}"`
  - [ ] 添加 `readonly` 属性（可选）
  - [ ] 添加提示信息（可选）
  - [ ] 添加修改按钮（可选）

- [ ] 其他主题同步修改（如果使用）
  - [ ] Hyper 主题
  - [ ] Unicorn 主题

### 10.2 测试清单

- [ ] 测试有email参数的URL
- [ ] 测试无email参数的URL
- [ ] 测试无效邮箱格式
- [ ] 测试特殊字符邮箱
- [ ] 测试只读状态
- [ ] 测试修改按钮
- [ ] 测试订单创建
- [ ] 测试支付流程

### 10.3 第三方网站集成

- [ ] 提供跳转URL格式文档
- [ ] 提供跳转按钮代码示例
- [ ] 提供JavaScript SDK（可选）
- [ ] 测试实际跳转流程

---

## 十一、总结

### 核心改动

**最小改动方案**（2个文件）:

1. **控制器**: 接收email参数并验证
2. **视图**: 邮箱input添加value属性

### 跳转URL格式

```
基础: https://dujiaoka.com/buy/1?email=user@example.com

带来源: https://dujiaoka.com/buy/1?email=user@example.com&source=ChatGPT

多字段: https://dujiaoka.com/buy/1?email=user@example.com&account=myname
```

### 用户体验

- ✅ 用户无需手动填写邮箱
- ✅ 减少输入错误
- ✅ 提高转化率
- ✅ 支持一键修改

---

**文档版本**: v1.0
**最后更新**: 2025-01-01
**相关文档**: 如何将邮箱传递给目标充值网站-完整指南.md, 充值账号(userId)获取与流转完整指南.md
